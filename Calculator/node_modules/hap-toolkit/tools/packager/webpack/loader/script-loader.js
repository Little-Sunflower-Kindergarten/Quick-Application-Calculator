/*
 * Copyright (C) 2017, hapjs.org. All rights reserved.
 */

'use strict';

var _compiler = require('../../compiler');

var _shared = require('../../common/shared');

var _utils = require('../../common/utils');

module.exports = function (source, map) {
  var _this = this;

  this.cacheable && this.cacheable();
  var callback = this.async();

  (0, _compiler.parseScript)(source).then(function (_ref) {
    var parsed = _ref.parsed;

    // 更新替换
    var fileRsut = (0, _shared.updateSourceScript)(parsed);
    // 内容替换
    parsed = fileRsut.fileCont;
    // 打印日志
    (0, _utils.logWarn)(_this, fileRsut.logFeatureList);

    // 如果是require('@xxxx'),则替换为$app_require$('@app-module/xxxx')
    var requireList = parsed.match(/require\s*\(['"]@([^/()]+?)['"]\)/g);
    if (requireList && requireList.length > 0) {
      requireList.forEach(function (str) {
        parsed = parsed.replace(str, str.replace('require', '$app_require$').replace('@', '@app-module/'));
      });
    }

    // 如果是import xxx from '@xxxx',则替换为var xxx = $app_require$('@app-module/xxxx')
    var importList = parsed.match(/import\s+([^()]+?)\s+from\s+['"]@([^/()]+?)['"]/g);
    if (importList && importList.length > 0) {
      importList.forEach(function (str) {
        parsed = parsed.replace(str, str.replace('import', 'var').replace('from', '= $app_require$(').replace('@', '@app-module/') + ');');
      });
    }

    var result = 'module.exports = function(module, exports, $app_require$){' + parsed + '}';
    callback(null, result, map);
  }).catch(function (e) {
    callback(e, '');
  });
};