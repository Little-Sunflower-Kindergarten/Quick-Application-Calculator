/*
 * Copyright (C) 2017, hapjs.org. All rights reserved.
 */

'use strict';

var _loaderUtils = require('loader-utils');

var _loaderUtils2 = _interopRequireDefault(_loaderUtils);

var _compiler = require('../../compiler');

var _utils = require('../../common/utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

module.exports = function (code) {
  var _this = this;

  this.cacheable && this.cacheable();
  var self = this;
  var callback = this.async();
  var loaderQuery = _loaderUtils2.default.parseQuery(this.query);
  var suppresslogs = !!(0, _utils.getWebpackOptions)(this).suppresslogs;

  (0, _compiler.parseStyle)({
    filePath: this.resourcePath,
    code: code,
    query: loaderQuery
  }).then(function (_ref) {
    var parsed = _ref.parsed,
        depList = _ref.depList,
        log = _ref.log;

    if (log && log.length) {
      (0, _utils.logWarn)(_this, log, suppresslogs);
    }

    // Recompile while dependency changed
    depList.forEach(function (depFilePath) {
      self.addDependency(depFilePath);
    });

    callback(null, parsed);
  }).catch(function (e) {
    callback(e, '');
  });
};