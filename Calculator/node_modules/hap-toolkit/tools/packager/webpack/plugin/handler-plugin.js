'use strict';

var _webpackSources = require('webpack-sources');

/**
 * 对createAppHandler, createPageHandler包装，使得同一套代码适应多个平台
 * @param options
 * @constructor
 */
function HandlerPlugin(options) {
  this.options = options;
} /*
   * Copyright (C) 2017, hapjs.org. All rights reserved.
   */

HandlerPlugin.prototype.apply = function (compiler) {
  compiler.plugin('compilation', function (compilation) {
    compilation.plugin('optimize-chunk-assets', function (chunks, callback) {
      chunks.forEach(function (chunk) {
        chunk.files.forEach(function (fileName) {
          var sourceList = wrapCode(fileName, compilation);
          sourceList && (compilation.assets[fileName] = sourceList);
        });
      });
      callback();
    });
  });
};

function wrapCode(fileName, compilation) {
  if (!new RegExp('.js$').test(fileName)) {
    return;
  }

  if (fileName.indexOf('app.js') === 0) {
    // src/app.js
    return new _webpackSources.ConcatSource(
    // Arg0
    '(function(){\n  ' + (process.env['NODE_TEST'] === 'Y' ? 'global = typeof window === "undefined" ? global.__proto__  : window ;' : '') + '\n  var createAppHandler = function() {\n    return ',
    // Arg1
    compilation.assets[fileName],
    // Arg2
    '\n  };\n  if (typeof window === "undefined") {\n    return createAppHandler();\n  }\n  else {\n    window.createAppHandler = createAppHandler\n    // H5\u6CE8\u5165manifest\u4EE5\u83B7\u53D6features\n    global.manifest = ' + JSON.stringify(global.framework.manifest) + ';\n  }\n})();');
  } else {
    // 非src/app.js
    return new _webpackSources.ConcatSource(
    // Arg0
    '(function(){\n  ' + (process.env['NODE_TEST'] === 'Y' ? 'global = typeof window === "undefined" ? global.__proto__  : window ;' : '') + '\n  var createPageHandler = function() {\n    return ',
    // Arg1
    compilation.assets[fileName],
    // Arg2
    '\n  };\n  if (typeof window === "undefined") {\n    return createPageHandler();\n  }\n  else {\n    window.createPageHandler = createPageHandler\n  }\n})();');
  }
}

module.exports = HandlerPlugin;